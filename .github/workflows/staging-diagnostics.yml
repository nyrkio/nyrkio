name: Staging Server Diagnostics

on:
  workflow_dispatch:

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Run diagnostics on staging server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          # Setup SSH
          mkdir -p $HOME/.ssh
          if [ -z "$SSH_AGENT_PID" ]; then
            eval $(ssh-agent)
            echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
            echo "SSH_AGENT_PID=SSH_AGENT_PID" >> $GITHUB_ENV
          fi

          echo "$SSH_PUBLIC_KEY" >> $HOME/.ssh/known_hosts
          echo "$SSH_PRIVATE_KEY" | ssh-add -

          echo "=== Staging Server Diagnostics ==="
          echo ""

          echo "1. Docker disk usage:"
          ssh $SSH_USER@staging.nyrkio.com "docker system df"
          echo ""

          echo "2. Docker info:"
          ssh $SSH_USER@staging.nyrkio.com "docker info | grep -E 'Storage Driver|Docker Root Dir|Containers|Images'"
          echo ""

          echo "3. ECR images present:"
          ssh $SSH_USER@staging.nyrkio.com "docker images | grep ecr || echo 'No ECR images found'"
          echo ""

          echo "4. Running containers:"
          ssh $SSH_USER@staging.nyrkio.com "docker ps -a"
          echo ""

          echo "5. Recent Docker events:"
          ssh $SSH_USER@staging.nyrkio.com "docker events --since 1h --until 0s | tail -50 || echo 'No recent events'"
          echo ""

          echo "6. Check for specific image:"
          ssh $SSH_USER@staging.nyrkio.com "docker images | grep 0823b75c842aacf716b2f621416445be153c28d8 || echo 'Image not found'"
          echo ""

          echo "7. Disk space:"
          ssh $SSH_USER@staging.nyrkio.com "df -h | grep -E 'Filesystem|/dev/'"
          echo ""

          echo "8. Docker daemon logs (last 50 lines):"
          ssh $SSH_USER@staging.nyrkio.com "sudo journalctl -u docker --no-pager -n 50 || echo 'Cannot access docker logs'"
